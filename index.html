<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geschäfts-Links - Eine URL für Alles</title>
    <!-- Lade Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* Konfiguriere Tailwind */
        body { font-family: 'Inter', sans-serif; }
        .link-button {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .link-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Haupt-Container für die Link-Seite -->
    <div id="app-container" class="w-full max-w-lg mx-auto bg-gray-800 rounded-xl shadow-2xl p-6 md:p-10">

        <!-- Lade-Indikator -->
        <div id="loading" class="text-center py-20">
            <i class="fas fa-spinner fa-spin text-4xl text-yellow-500"></i>
            <p class="mt-4 text-gray-400">Daten werden geladen...</p>
        </div>

        <!-- Haupt-Inhalt (wird von JS gefüllt) -->
        <div id="content" class="hidden">
            <div id="profile-header" class="text-center mb-8">
                <!-- Icon oder Logo Placeholder -->
                <div class="w-24 h-24 bg-yellow-500 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl font-bold text-gray-900">
                    <i class="fas fa-link"></i>
                </div>
                <h1 id="business-name" class="text-3xl font-bold">Ihr Geschäft</h1>
                <p class="text-gray-400 mt-1">Alle wichtigen Links auf einen Blick.</p>
            </div>

            <!-- Link-Buttons Container -->
            <div id="links-container" class="space-y-4">
                <!-- Buttons werden hier von JavaScript eingefügt -->
            </div>
        </div>

        <!-- Admin-Modus (wird von JS gesteuert) -->
        <div id="admin-panel" class="hidden mt-8 border-t border-gray-700 pt-6">
            <h2 class="text-xl font-semibold mb-4 text-yellow-500">Admin-Modus: Links bearbeiten</h2>
            
            <!-- NEU: GEMINI AI Feature -->
            <div class="mt-4 mb-8 p-4 bg-gray-700 rounded-xl shadow-inner border border-indigo-500">
                <h3 class="text-lg font-semibold mb-3 text-yellow-300 flex items-center">
                    Inhalt generieren mit KI ✨
                </h3>
                <label class="block mb-3">
                    <span class="text-gray-400">Plattform/Ziel (z.B. 'Instagram Story', 'Facebook Post', 'Blog-Einleitung'):</span>
                    <input type="text" id="ai-platform-goal" placeholder="z.B. Kurzer Text für die neue Winterkollektion" class="w-full mt-1 p-2 bg-gray-800 border border-gray-600 rounded-lg text-white">
                </label>
                <button id="generate-copy-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-150">
                    <i class="fas fa-magic mr-2"></i> Marketing-Text generieren
                </button>
                
                <div id="ai-result-container" class="mt-4 hidden">
                    <p class="text-gray-400 mb-2">Generierter Text:</p>
                    <textarea id="ai-generated-text" rows="5" readonly class="w-full p-3 bg-gray-800 border border-indigo-500 rounded-lg text-white focus:outline-none"></textarea>
                    <!-- Verwenden Sie onclick, um die globale Helper-Funktion aufzurufen -->
                    <button onclick="copyToClipboard('ai-generated-text')" class="mt-2 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg text-sm">
                        <i class="fas fa-copy mr-2"></i> Kopieren
                    </button>
                </div>
                <p id="ai-status-message" class="mt-2 text-center text-sm"></p>
            </div>

            <form id="admin-form" class="space-y-4">
                
                <label class="block">
                    <span class="text-gray-400">Name des Geschäfts:</span>
                    <input type="text" id="admin-business-name" class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-yellow-500 focus:border-yellow-500" required>
                </label>

                <!-- Dynamische Link-Felder werden hier von JavaScript eingefügt -->
                <div id="admin-links-fields" class="space-y-4"></div>

                <button type="submit" id="save-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-bold py-3 rounded-lg shadow-md transition duration-150">
                    <i class="fas fa-save mr-2"></i> Links speichern
                </button>
            </form>
            <p id="admin-message" class="mt-4 text-center text-sm"></p>
        </div>

    </div>

    <!-- Firebase SDKs (Muss vor dem eigenen Script geladen werden) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // WICHTIG: Verwenden Sie die globalen Variablen des Canvas-Frameworks
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        async function initApp() {

            if (!firebaseConfig) {
                console.error("Firebase Konfiguration nicht gefunden.");
                document.getElementById('loading').innerHTML = '<p class="text-red-500">Fehler: Firebase-Konfiguration fehlt.</p>';
                return;
            }

            // --- FIREBASE INITIALISIERUNG ---
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // Debug-Logging für Firestore (optional, kann entfernt werden)
            setLogLevel('Debug'); 

            let authReady = false;

            // --- HILFSFUNKTIONEN ---

            /**
             * Konfiguriert den öffentlichen Pfad zur Datenbank. 
             * Path: /artifacts/{appId}/public/data/business_links/{appId}-config
             */
            function getDocRef() {
                // Wir verwenden die appId als eindeutigen Dokumentnamen, da alle Benutzer (anonym/angemeldet)
                // dieselben Links für diese spezifische App-Instanz sehen sollen.
                return doc(db, 'artifacts', appId, 'public', 'data', 'business_links', `${appId}-config`);
            }

            /**
             * Das Standard-Datenmodell für neue Geschäfte.
             */
            const DEFAULT_LINKS = {
                // HINWEIS: ownerId wird beim ersten Speichern gesetzt
                ownerId: '', 
                businessName: "Mein cooles Geschäft",
                links: [
                    { platform: "Website", url: "https://mein-geschaeft.de", icon: "fa-globe", color: "bg-blue-600", placeholder: "https://Ihre-Website.de" },
                    { platform: "Facebook", url: "https://facebook.com/meingeschaeft", icon: "fa-facebook", color: "bg-blue-800", placeholder: "https://facebook.com/profil" },
                    { platform: "Instagram", url: "https://instagram.com/meingeschaeft", icon: "fa-instagram", color: "bg-pink-600", placeholder: "https://instagram.com/profil" },
                    { platform: "WhatsApp", url: "https://wa.me/4917612345678", icon: "fa-whatsapp", color: "bg-green-600", placeholder: "https://wa.me/landesvorwahlnummer" },
                    { platform: "Telegram", url: "https://t.me/meingeschaeft", icon: "fa-telegram", color: "bg-sky-500", placeholder: "https://t.me/kanalname" }
                ]
            };
            
            /**
             * Kopiert Text in die Zwischenablage und zeigt eine Meldung an.
             * @param {string} elementId - ID des Textbereichs, dessen Inhalt kopiert werden soll.
             */
            function copyToClipboard(elementId) {
                const element = document.getElementById(elementId);
                element.select();
                element.setSelectionRange(0, 99999); // Für mobile Geräte
                
                const messageEl = document.getElementById('ai-status-message');
                try {
                    // Verwende document.execCommand('copy') als Fallback/für iFrames
                    const successful = document.execCommand('copy');
                    messageEl.textContent = successful ? 'Text in die Zwischenablage kopiert!' : 'Kopieren fehlgeschlagen.';
                    messageEl.className = successful ? 'mt-2 text-center text-sm text-green-500' : 'mt-2 text-center text-sm text-red-500';
                } catch (err) {
                    console.error('Kopierversuch fehlgeschlagen', err);
                    messageEl.textContent = 'Kopieren fehlgeschlagen.';
                    messageEl.className = 'mt-2 text-center text-sm text-red-500';
                }
            }
            window.copyToClipboard = copyToClipboard; // Global verfügbar machen für onclick

            // --- AUTHENTIFIZIERUNG UND INITIALISIERUNG ---

            onAuthStateChanged(auth, async (user) => {
                // Wichtig: onAuthStateChanged wird immer als Erstes ausgelöst,
                // auch wenn der Benutzer anonym ist.
                authReady = true;
                const params = new URLSearchParams(window.location.search);
                const isAdmin = params.get('admin') === 'true';
                
                // Verstecke Ladeanzeige
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden'); 
                
                // Starte die App-Ansicht erst, nachdem die Auth-Prüfung abgeschlossen ist
                if (isAdmin) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    document.getElementById('admin-form').addEventListener('submit', handleSaveLinks);
                    document.getElementById('generate-copy-btn').addEventListener('click', generateMarketingCopy);
                    await loadLinksForAdmin();
                } else {
                    setupRealtimeListener();
                }
            });

            async function authenticate() {
                try {
                    // Melde dich mit dem CustomToken an, falls vorhanden (für den Ersteller)
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Angemeldet als Erst-Ersteller.");
                    } else {
                        // Andernfalls melde dich anonym an (für Lesezugriff)
                        await signInAnonymously(auth);
                        console.log("Angemeldet als anonymer Benutzer.");
                    }
                } catch (error) {
                    console.error("Fehler bei der Anmeldung:", error);
                    document.getElementById('loading').innerHTML = '<p class="text-red-500">Fehler bei der Anmeldung. Bitte versuchen Sie es später erneut.</p>';
                }
            }
            
            /**
             * Richte einen Echtzeit-Listener für den normalen Modus ein (Link-Anzeige).
             */
            function setupRealtimeListener() {
                const docRef = getDocRef();

                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        renderLinks(data);
                    } else {
                        // Zeige Standardtexte, wenn das Dokument noch nicht existiert.
                        renderLinks({ businessName: DEFAULT_LINKS.businessName, links: [] }); 
                    }
                }, (error) => {
                    console.error("Firestore-Listener-Fehler:", error);
                    document.getElementById('links-container').innerHTML = '<p class="text-red-400 text-center">Fehler beim Laden der Links. Die Anwendung ist möglicherweise noch nicht konfiguriert oder die Netzwerkverbindung ist gestört.</p>';
                });
            }
            
            /**
             * Rendert die Links in die Hauptansicht.
             */
            function renderLinks(data) {
                document.getElementById('business-name').textContent = data.businessName || 'Links';
                const container = document.getElementById('links-container');
                container.innerHTML = ''; // Lösche alte Buttons

                if (data.links && Array.isArray(data.links)) {
                    const activeLinks = data.links.filter(link => link.url && link.url.trim() !== '');
                    
                    if (activeLinks.length === 0) {
                         container.innerHTML = '<p class="text-gray-400 text-center">Keine Links konfiguriert.</p>';
                         return;
                    }

                    activeLinks.forEach(link => {
                        const button = document.createElement('a');
                        button.href = link.url;
                        button.target = "_blank"; // In neuem Tab öffnen
                        button.className = `link-button w-full flex items-center justify-center ${link.color || 'bg-gray-700'} text-white font-semibold py-4 rounded-lg shadow-lg uppercase tracking-wider`;
                        
                        button.innerHTML = `
                            <i class="fab ${link.icon || 'fa-link'} text-xl mr-3"></i>
                            <span>${link.platform}</span>
                        `;
                        container.appendChild(button);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-400 text-center">Keine Links konfiguriert.</p>';
                }
            }

            /**
             * Lädt die Links für die Admin-Ansicht (Formular).
             */
            async function loadLinksForAdmin() {
                if (!authReady) return;

                const currentUserId = auth.currentUser?.uid;
                const docRef = getDocRef();
                const docSnap = await getDoc(docRef);
                const fieldsContainer = document.getElementById('admin-links-fields');
                const adminForm = document.getElementById('admin-form');
                const messageEl = document.getElementById('admin-message');
                const saveButton = document.getElementById('save-button');
                
                let data;
                let isOwner = false;
                
                if (docSnap.exists()) {
                    data = docSnap.data();
                    // Prüfen, ob der Benutzer der Owner ist
                    isOwner = currentUserId && data.ownerId === currentUserId;
                } else {
                    // Dokument existiert nicht: Jede angemeldete Person kann es erstellen
                    data = { ...DEFAULT_LINKS, ownerId: currentUserId || '' };
                    isOwner = currentUserId !== null; // Nur angemeldete Benutzer dürfen erstellen
                }
                
                // Formularzustand basierend auf Besitz
                if (!currentUserId) {
                    messageEl.textContent = 'Zur Bearbeitung müssen Sie angemeldet sein.';
                    messageEl.className = 'mt-4 text-center text-sm text-red-500 font-bold';
                    saveButton.disabled = true;
                } else if (!isOwner && data.ownerId) {
                    messageEl.textContent = `Sie sind nicht der Ersteller dieses Links (${data.ownerId}). Die Bearbeitung ist gesperrt.`;
                    messageEl.className = 'mt-4 text-center text-sm text-red-500 font-bold';
                    saveButton.disabled = true;
                } else if (isOwner) {
                     messageEl.textContent = `Admin-Modus. Sie sind der Ersteller (${currentUserId}).`;
                     messageEl.className = 'mt-4 text-center text-sm text-green-500 font-bold';
                     saveButton.disabled = false;
                }


                document.getElementById('admin-business-name').value = data.businessName || '';
                fieldsContainer.innerHTML = '';

                const linksToEdit = data.links || DEFAULT_LINKS.links;

                linksToEdit.forEach((link, index) => {
                    const linkDiv = document.createElement('div');
                    linkDiv.className = 'p-3 bg-gray-700 rounded-lg';
                    // Deaktivieren der Felder, wenn der Benutzer nicht der Owner ist
                    const disabledAttr = isOwner ? '' : 'disabled'; 

                    linkDiv.innerHTML = `
                        <h4 class="font-medium mb-2">${link.platform} Link:</h4>
                        <input type="url" 
                            data-platform="${link.platform}"
                            data-icon="${link.icon}"
                            data-color="${link.color}"
                            value="${link.url || ''}"
                            placeholder="${link.placeholder || 'https://link-hier-einfügen.de'}"
                            class="link-input w-full p-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:ring-yellow-500 focus:border-yellow-500" 
                            required 
                            ${disabledAttr}>
                    `;
                    fieldsContainer.appendChild(linkDiv);
                });
                
                // Zeige die Live-Vorschau mit den Admin-Daten
                renderLinks(data); 
                
                // Richte den Echtzeit-Listener ein, falls das Dokument existiert, um Änderungen von anderen Instanzen zu sehen
                if (docSnap.exists()) {
                     setupRealtimeListener();
                }
            }

            /**
             * Speichert die bearbeiteten Links in Firestore.
             */
            async function handleSaveLinks(event) {
                event.preventDefault();
                
                const messageEl = document.getElementById('admin-message');
                const currentUserId = auth.currentUser?.uid;
                
                if (!currentUserId) {
                     messageEl.textContent = 'Fehler: Sie müssen angemeldet sein, um zu speichern.';
                     messageEl.className = 'mt-4 text-center text-sm text-red-500';
                     return;
                }

                // Prüfen der Schreibberechtigung (wird durch Firestore Rules und UI-Sperre abgedeckt)
                // Die Owner-Prüfung erfolgt implizit beim `setDoc`

                messageEl.textContent = 'Speichere...';
                messageEl.className = 'mt-4 text-center text-sm text-yellow-500';
                
                try {
                    const businessName = document.getElementById('admin-business-name').value.trim();
                    const inputs = document.querySelectorAll('.link-input');
                    
                    const updatedLinks = Array.from(inputs).map(input => ({
                        platform: input.getAttribute('data-platform'),
                        url: input.value.trim(),
                        icon: input.getAttribute('data-icon'),
                        color: input.getAttribute('data-color'),
                        placeholder: input.placeholder 
                    }));

                    const newData = {
                        // WICHTIG: Setze die OwnerId fest auf den aktuellen Benutzer für die Security Rules
                        ownerId: currentUserId, 
                        businessName: businessName,
                        links: updatedLinks
                    };

                    const docRef = getDocRef(); // Öffentlicher Pfad
                    await setDoc(docRef, newData);

                    messageEl.textContent = 'Links erfolgreich gespeichert!';
                    messageEl.className = 'mt-4 text-center text-sm text-green-500';
                    
                    // Aktualisiere die Vorschau sofort
                    renderLinks(newData);

                } catch (error) {
                    console.error("Fehler beim Speichern der Links:", error);
                    // Die Fehlermeldung wird nun spezifischer ausgegeben
                    messageEl.textContent = `Fehler beim Speichern: ${error.message}. Sie haben möglicherweise keine Schreibberechtigung.`;
                    messageEl.className = 'mt-4 text-center text-sm text-red-500';
                }
            }

            /**
             * Generiert Marketing-Text basierend auf Geschäftsname und Zielplattform mithilfe der Gemini API.
             */
            async function generateMarketingCopy() {
                const button = document.getElementById('generate-copy-btn');
                const statusEl = document.getElementById('ai-status-message');
                const resultContainer = document.getElementById('ai-result-container');
                const resultTextarea = document.getElementById('ai-generated-text');
                
                const businessName = document.getElementById('admin-business-name').value.trim() || 'Lokales Geschäft (Name unbekannt)';
                const platformGoal = document.getElementById('ai-platform-goal').value.trim();

                if (!platformGoal) {
                    statusEl.textContent = 'Bitte geben Sie ein Ziel ein (z.B. "Instagram Post für Frühlingsrabatt").';
                    statusEl.className = 'mt-2 text-center text-sm text-red-500';
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generiere...';
                statusEl.textContent = 'Verbindung zur KI wird hergestellt...';
                statusEl.className = 'mt-2 text-center text-sm text-yellow-500';
                resultContainer.classList.add('hidden');
                resultTextarea.value = '';

                try {
                    const systemPrompt = `Sie sind ein professioneller Social Media Content Manager und Texter. Ihre Aufgabe ist es, prägnanten, ansprechenden und verkaufsfördernden Marketing-Text zu generieren. Halten Sie den Ton je nach Plattform angemessen (z.B. kurz und visuell für Instagram, informativer für Facebook). Verwenden Sie relevante Emojis und halten Sie sich an die deutsche Sprache. Geben Sie nur den reinen, formatierten Text zurück, keine Überschriften oder Einleitungen.`;
                    
                    const userQuery = `Erstelle einen Marketing-Text für das Geschäft "${businessName}". Das Ziel ist: "${platformGoal}".`;
                    
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    
                    let attempt = 0;
                    const maxRetries = 5;
                    let response;
                    
                    while (attempt < maxRetries) {
                        try {
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (response.ok) {
                                break; // Erfolg, Schleife verlassen
                            } else if (response.status === 429 && attempt < maxRetries - 1) {
                                // Rate Limit, mit Exponential Backoff warten
                                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                                attempt++;
                                statusEl.textContent = `Warte auf Wiederholung... (${attempt}/${maxRetries})`;
                                await new Promise(resolve => setTimeout(resolve, delay));
                            } else {
                                // Anderer HTTP-Fehler
                                throw new Error(`API-Fehler: ${response.statusText}`);
                            }
                        } catch (error) {
                            if (attempt === maxRetries - 1) {
                                throw error; // Letzter Versuch fehlgeschlagen
                            }
                            // Nur für Netzwerkfehler wiederholen, Rate Limit wird oben behandelt
                            attempt++;
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            statusEl.textContent = `Warte auf Wiederholung... (${attempt}/${maxRetries})`;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }

                    if (!response || !response.ok) {
                        throw new Error("Generierung fehlgeschlagen nach mehreren Versuchen.");
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (generatedText) {
                        resultTextarea.value = generatedText;
                        resultContainer.classList.remove('hidden');
                        statusEl.textContent = 'Marketing-Text erfolgreich generiert!';
                        statusEl.className = 'mt-2 text-center text-sm text-green-500';
                    } else {
                        throw new Error("Kein Text von der API erhalten.");
                    }

                } catch (error) {
                    console.error("Fehler bei der KI-Generierung:", error);
                    statusEl.textContent = `Fehler bei der Generierung: ${error.message}`;
                    statusEl.className = 'mt-2 text-center text-sm text-red-500';
                    resultContainer.classList.add('hidden');
                } finally {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-magic mr-2"></i> Marketing-Text generieren';
                }
            }
            
            // Starte den Authentifizierungsprozess
            authenticate();
        }
        
        // Starte die Anwendung
        initApp();
    </script>
</body>
</html>
